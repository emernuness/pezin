generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  creator
  consumer
}

enum PackStatus {
  draft
  published
  unpublished
  deleted
}

enum PurchaseStatus {
  pending
  paid
  refunded
}

enum WithdrawalStatus {
  pending
  processing
  completed
  failed
}

// ==========================================
// GATEWAY AGNOSTIC FINANCIAL MODULE - ENUMS
// ==========================================

enum LedgerEntryType {
  CREDIT
  DEBIT
}

enum TransactionType {
  SALE          // Venda de pack (crédito para criador)
  PLATFORM_FEE  // Taxa da plataforma (crédito para plataforma)
  PAYOUT        // Saque para criador (débito da wallet)
  REFUND        // Reembolso (débito da wallet)
  ADJUSTMENT    // Ajuste manual (admin)
  RELEASE       // Liberação de saldo congelado para disponível
}

enum PaymentStatus {
  pending
  paid
  expired
  cancelled
  refunded
}

enum PayoutStatus {
  pending
  processing
  completed
  failed
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  displayName   String?
  slug          String?  @unique
  bio           String?  @db.VarChar(500)
  profileImage  String?
  coverImage    String?
  birthDate     DateTime
  userType      UserType
  emailVerified Boolean  @default(false)

  // Personal data (required for creators to receive payments)
  fullName      String?  // Legal name for documents
  cpf           String?  @unique // Brazilian CPF (required for Stripe Connect BR)
  phone         String?  // Phone number with country code

  // Address (required for Stripe Connect)
  addressZipCode      String?
  addressStreet       String?
  addressNumber       String?
  addressComplement   String?
  addressNeighborhood String?
  addressCity         String?
  addressState        String?

  // Stripe Connect (for creators) - LEGACY
  stripeAccountId String? @unique
  stripeConnected Boolean @default(false)

  // PIX Key for receiving payouts (Gateway Agnostic)
  pixKey     String?
  pixKeyType String? // 'cpf', 'cnpj', 'email', 'phone', 'evp'

  // Email verification
  verificationToken String?
  verificationTokenExpires DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  refreshTokens RefreshToken[]
  packs         Pack[]
  purchases     Purchase[]     // Legacy Stripe purchases
  withdrawals   Withdrawal[]   // Legacy Stripe withdrawals
  downloadLogs  DownloadLog[]

  // Gateway Agnostic Relations
  wallet          Wallet?
  paymentsBuyer   Payment[]    @relation("PaymentsBuyer")
  paymentsCreator Payment[]    @relation("PaymentsCreator")
  payouts         Payout[]

  @@index([email])
  @@index([userType])
  @@index([slug])
  @@index([cpf])
}

model RefreshToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  revokedAt DateTime?

  // Token rotation tracking
  rotatedFromTokenId String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model Pack {
  id          String     @id @default(cuid())
  creatorId   String
  creator     User       @relation(fields: [creatorId], references: [id])

  title       String     @db.VarChar(100)
  description String?    @db.VarChar(1000)
  price       Int        // Centavos
  status      PackStatus @default(draft)

  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?
  deletedAt   DateTime?

  // Relations
  previews  PackPreview[]
  files     PackFile[]
  purchases Purchase[]   // Legacy Stripe purchases
  payments  Payment[]    // Gateway Agnostic payments

  @@index([creatorId, status])
  @@index([status, publishedAt])
}

model PackPreview {
  id     String @id @default(cuid())
  packId String
  pack   Pack   @relation(fields: [packId], references: [id], onDelete: Cascade)

  url   String
  order Int

  @@index([packId])
}

model PackFile {
  id         String @id @default(cuid())
  packId     String
  pack       Pack   @relation(fields: [packId], references: [id], onDelete: Cascade)

  filename   String
  mimeType   String
  size       Int    // Bytes
  storageKey String // S3/R2 key
  order      Int

  // Relations
  downloadLogs DownloadLog[]

  @@index([packId])
}

model Purchase {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  packId    String
  pack      Pack           @relation(fields: [packId], references: [id])
  creatorId String

  amount            Int // Total em centavos
  platformFee       Int // 20% para plataforma
  creatorEarnings   Int // 80% para criador

  stripePaymentIntentId String @unique
  status                PurchaseStatus

  availableAt DateTime // +14 dias anti-fraude
  createdAt   DateTime @default(now())
  refundedAt  DateTime?

  @@index([userId])
  @@index([creatorId, status])
  @@index([packId])
  @@index([stripePaymentIntentId])
}

model Withdrawal {
  id        String           @id @default(cuid())
  creatorId String
  creator   User             @relation(fields: [creatorId], references: [id])

  amount         Int
  stripePayoutId String?
  status         WithdrawalStatus

  requestedAt   DateTime  @default(now())
  processedAt   DateTime?
  failedAt      DateTime?
  failureReason String?

  @@index([creatorId, status])
}

// Para controle de download (RN-23: 10 downloads por arquivo por dia)
model DownloadLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])
  fileId String
  file   PackFile @relation(fields: [fileId], references: [id])
  packId String

  dateKey   String   // YYYY-MM-DD format
  count     Int      @default(1)

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, fileId, dateKey])
  @@index([userId, fileId, dateKey])
}

// Para idempotência de webhooks Stripe (LEGACY)
model StripeEvent {
  id          String   @id // Stripe event ID
  type        String
  processed   Boolean  @default(false)
  processedAt DateTime?
  payload     String   @db.Text // JSON do evento

  createdAt DateTime @default(now())

  @@index([id, processed])
}

// ==========================================
// GATEWAY AGNOSTIC FINANCIAL MODULE - MODELS
// ==========================================

// Carteira virtual do criador
model Wallet {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Saldos (em centavos)
  currentBalance Int @default(0) // Saldo disponível para saque
  frozenBalance  Int @default(0) // Saldo retido (14 dias anti-fraude)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ledgerEntries LedgerEntry[]
  payouts       Payout[]

  @@index([userId])
}

// Registro contábil (double-entry bookkeeping simplificado)
model LedgerEntry {
  id String @id @default(cuid())

  // Referência à carteira (origem ou destino)
  walletId String?
  wallet   Wallet? @relation(fields: [walletId], references: [id])

  // Para transações da plataforma (sem wallet de usuário)
  isPlatformEntry Boolean @default(false)

  // Tipo de entrada
  type            LedgerEntryType
  transactionType TransactionType

  // Valor em centavos
  amount       Int
  balanceAfter Int // Snapshot do saldo após a transação

  // Referências às transações originais
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id])
  payoutId  String?
  payout    Payout?  @relation(fields: [payoutId], references: [id])

  // Auditoria
  description String?
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([paymentId])
  @@index([payoutId])
  @@index([transactionType])
  @@index([createdAt])
}

// Pagamento via PIX (substitui Purchase para novos pagamentos)
model Payment {
  id String @id @default(cuid())

  // Participantes
  buyerId   String
  buyer     User   @relation("PaymentsBuyer", fields: [buyerId], references: [id])
  creatorId String
  creator   User   @relation("PaymentsCreator", fields: [creatorId], references: [id])
  packId    String
  pack      Pack   @relation(fields: [packId], references: [id])

  // Valores em centavos
  amount          Int // Valor total pago pelo comprador
  platformFee     Int // 20% para plataforma
  creatorEarnings Int // 80% para criador

  // Gateway
  gateway   String  // 'suitpay', 'ezzepay', 'voluti'
  gatewayId String? // ID da transação no gateway

  // PIX
  pixQrCode     String?   @db.Text // QR Code base64
  pixQrCodeText String?   @db.Text // PIX Copia e Cola
  pixExpiresAt  DateTime?

  // Status
  status PaymentStatus @default(pending)

  // Anti-fraude: data em que o valor fica disponível para saque
  availableAt DateTime // +14 dias após pagamento

  // Flag para indicar se o saldo já foi liberado (frozen → available)
  balanceReleased Boolean @default(false)

  // Timestamps
  createdAt  DateTime  @default(now())
  paidAt     DateTime?
  expiredAt  DateTime?
  refundedAt DateTime?

  // Relations
  ledgerEntries LedgerEntry[]

  // Idempotência: evita compra duplicada pendente do mesmo usuário para o mesmo pack
  @@unique([buyerId, packId, status])
  @@index([buyerId])
  @@index([creatorId, status])
  @@index([packId])
  @@index([gatewayId])
  @@index([status])
  @@index([availableAt, balanceReleased])
}

// Saque via PIX
model Payout {
  id String @id @default(cuid())

  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])
  walletId  String
  wallet    Wallet @relation(fields: [walletId], references: [id])

  // Valor em centavos
  amount Int

  // Gateway
  gateway   String  // 'suitpay', 'ezzepay', 'voluti'
  gatewayId String? // ID do payout no gateway

  // PIX destino
  pixKey            String
  pixKeyType        String // 'cpf', 'cnpj', 'email', 'phone', 'evp'
  recipientName     String
  recipientDocument String // CPF/CNPJ

  // Status
  status PayoutStatus @default(pending)

  // Timestamps
  requestedAt   DateTime  @default(now())
  processedAt   DateTime?
  completedAt   DateTime?
  failedAt      DateTime?
  failureReason String?

  // Relations
  ledgerEntries LedgerEntry[]

  @@index([creatorId, status])
  @@index([walletId])
  @@index([gatewayId])
}

// Evento de webhook genérico (para qualquer gateway)
model WebhookEvent {
  id String @id @default(cuid())

  gateway        String // 'suitpay', 'ezzepay', 'voluti'
  gatewayEventId String // ID original do evento no gateway
  eventType      String // 'payment.paid', 'payment.expired', 'payout.completed', etc.

  payload String @db.Text // JSON do evento

  processed   Boolean   @default(false)
  processedAt DateTime?

  error      String?
  retryCount Int     @default(0)

  createdAt DateTime @default(now())

  @@unique([gateway, gatewayEventId])
  @@index([gateway, processed])
  @@index([createdAt])
}
